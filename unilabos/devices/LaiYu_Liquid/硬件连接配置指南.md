# LaiYuæ¶²ä½“å¤„ç†è®¾å¤‡ç¡¬ä»¶è¿æ¥é…ç½®æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æŒ‡å—è¯¦ç»†è¯´æ˜å¦‚ä½•é…ç½®LaiYuæ¶²ä½“å¤„ç†è®¾å¤‡çš„ç¡¬ä»¶è¿æ¥å‚æ•°ï¼ŒåŒ…æ‹¬ä¸²å£é…ç½®ã€è®¾å¤‡åœ°å€è®¾ç½®å’Œè¿æ¥çŠ¶æ€éªŒè¯ã€‚

## ğŸ”Œ ç¡¬ä»¶è¿æ¥æ¶æ„

LaiYuæ¶²ä½“å¤„ç†è®¾å¤‡åŒ…å«ä¸¤ä¸ªä¸»è¦ç¡¬ä»¶ç»„ä»¶ï¼š

### 1. XYZä¸‰è½´æ­¥è¿›ç”µæœºæ§åˆ¶å™¨
- **é€šä¿¡åè®®**: RS485 (Modbus)
- **é»˜è®¤æ³¢ç‰¹ç‡**: 115200
- **æ•°æ®ä½**: 8
- **åœæ­¢ä½**: 1
- **æ ¡éªŒä½**: æ— 

### 2. SOPAæ°”åŠ¨å¼ç§»æ¶²å™¨
- **é€šä¿¡åè®®**: RS485
- **é»˜è®¤æ³¢ç‰¹ç‡**: 115200  
- **è®¾å¤‡åœ°å€**: 1-254 (ç¦ç”¨: 47, 69, 91)
- **é€šä¿¡ç±»å‹**: ç»ˆç«¯è°ƒè¯•æ¨¡å¼ ("/") æˆ– OEMé€šä¿¡æ¨¡å¼ ("[")

## âš™ï¸ é…ç½®æ–‡ä»¶ä¿®æ”¹

### 1. ä¸»é…ç½®æ–‡ä»¶ä½ç½®

é…ç½®å‚æ•°ä¸»è¦åœ¨ä»¥ä¸‹æ–‡ä»¶ä¸­è®¾ç½®ï¼š

#### A. è®¾å¤‡é…ç½®ç±» (`LaiYu_Liquid.py`)
```python
@dataclass
class LaiYuLiquidConfig:
    # ä¸²å£è¿æ¥å‚æ•°
    port: str = "/dev/cu.usbserial-3130"  # ğŸ”§ ä¿®æ”¹è¿™é‡Œçš„ä¸²å£å·
    address: int = 1                       # ğŸ”§ ä¿®æ”¹è®¾å¤‡åœ°å€
    baudrate: int = 9600                   # ğŸ”§ ä¿®æ”¹æ³¢ç‰¹ç‡
    timeout: float = 5.0                   # ğŸ”§ ä¿®æ”¹è¶…æ—¶æ—¶é—´
    
    # å·¥ä½œå°ç‰©ç†å°ºå¯¸
    deck_width: float = 340.0              # å·¥ä½œå°å®½åº¦ (mm)
    deck_height: float = 250.0             # å·¥ä½œå°é«˜åº¦ (mm) 
    deck_depth: float = 160.0              # å·¥ä½œå°æ·±åº¦ (mm)
    
    # å…¶ä»–å‚æ•°...
```

#### B. å®éªŒé…ç½®æ–‡ä»¶ (`test/experiments/laiyu_liquid.json`)
```json
{
    "config": {
        "port": "/dev/cu.usbserial-3130",    // ğŸ”§ ä¿®æ”¹ä¸²å£å·
        "address": 1,                        // ğŸ”§ ä¿®æ”¹è®¾å¤‡åœ°å€
        "baudrate": 9600,                    // ğŸ”§ ä¿®æ”¹æ³¢ç‰¹ç‡
        "timeout": 5.0,                      // ğŸ”§ ä¿®æ”¹è¶…æ—¶æ—¶é—´
        "deck_width": 340.0,
        "deck_height": 250.0,
        "deck_depth": 160.0
        // å…¶ä»–é…ç½®...
    }
}
```

### 2. ä¸²å£å·è¯†åˆ«å’Œé…ç½®

#### macOSç³»ç»Ÿ
```bash
# æŸ¥çœ‹æ‰€æœ‰ä¸²å£è®¾å¤‡
ls /dev/cu.*

# å¸¸è§çš„ä¸²å£è®¾å¤‡åç§°
/dev/cu.usbserial-*     # USBè½¬ä¸²å£è®¾å¤‡
/dev/cu.usbmodem*       # USBè°ƒåˆ¶è§£è°ƒå™¨
/dev/cu.SLAB_USBtoUART  # Silicon Labs CP210x
/dev/cu.wchusbserial*   # WCH CH340/CH341
```

#### Linuxç³»ç»Ÿ
```bash
# æŸ¥çœ‹ä¸²å£è®¾å¤‡
ls /dev/ttyUSB* /dev/ttyACM*

# æŸ¥çœ‹è®¾å¤‡è¯¦ç»†ä¿¡æ¯
dmesg | grep tty
lsusb
```

#### Windowsç³»ç»Ÿ
```bash
# åœ¨è®¾å¤‡ç®¡ç†å™¨ä¸­æŸ¥çœ‹"ç«¯å£(COMå’ŒLPT)"
# å¸¸è§æ ¼å¼: COM1, COM2, COM3...
```

### 3. æ§åˆ¶å™¨ç‰¹å®šé…ç½®

#### XYZæ§åˆ¶å™¨é…ç½® (`controllers/xyz_controller.py`)
```python
def __init__(self, port: str, baudrate: int = 115200, 
             machine_config: Optional[MachineConfig] = None,
             config_file: str = "machine_config.json",
             auto_connect: bool = True):
    """
    Args:
        port: ä¸²å£ç«¯å£ (å¦‚: "/dev/cu.usbserial-3130")
        baudrate: æ³¢ç‰¹ç‡ (é»˜è®¤: 115200)
        machine_config: æœºæ¢°é…ç½®å‚æ•°
        config_file: é…ç½®æ–‡ä»¶è·¯å¾„
        auto_connect: æ˜¯å¦è‡ªåŠ¨è¿æ¥
    """
```

#### ç§»æ¶²å™¨æ§åˆ¶å™¨é…ç½® (`controllers/pipette_controller.py`)
```python
@dataclass
class SOPAConfig:
    # é€šä¿¡å‚æ•°
    port: str = "/dev/ttyUSB0"              # ğŸ”§ ä¿®æ”¹ä¸²å£å·
    baudrate: int = 115200                  # ğŸ”§ ä¿®æ”¹æ³¢ç‰¹ç‡
    address: int = 1                        # ğŸ”§ ä¿®æ”¹è®¾å¤‡åœ°å€ (1-254)
    timeout: float = 5.0                    # ğŸ”§ ä¿®æ”¹è¶…æ—¶æ—¶é—´
    comm_type: CommunicationType = CommunicationType.TERMINAL_DEBUG
```

## ğŸ” è¿æ¥çŠ¶æ€éªŒè¯

### 1. ç¼–ç¨‹æ–¹å¼éªŒè¯è¿æ¥

#### åˆ›å»ºæµ‹è¯•è„šæœ¬
```python
#!/usr/bin/env python3
"""
LaiYuæ¶²ä½“å¤„ç†è®¾å¤‡è¿æ¥æµ‹è¯•è„šæœ¬
"""

import sys
import os
sys.path.append('/Users/dp/Documents/DPT/HuaiRou/Uni-Lab-OS')

from unilabos.devices.LaiYu_Liquid.LaiYu_Liquid import (
    LaiYuLiquid, LaiYuLiquidConfig
)

def test_connection():
    """æµ‹è¯•è®¾å¤‡è¿æ¥"""
    
    # ğŸ”§ ä¿®æ”¹è¿™é‡Œçš„é…ç½®å‚æ•°
    config = LaiYuLiquidConfig(
        port="/dev/cu.usbserial-3130",  # ä¿®æ”¹ä¸ºä½ çš„ä¸²å£å·
        address=1,                       # ä¿®æ”¹ä¸ºä½ çš„è®¾å¤‡åœ°å€
        baudrate=9600,                   # ä¿®æ”¹ä¸ºä½ çš„æ³¢ç‰¹ç‡
        timeout=5.0
    )
    
    print("ğŸ”Œ æ­£åœ¨æµ‹è¯•LaiYuæ¶²ä½“å¤„ç†è®¾å¤‡è¿æ¥...")
    print(f"ä¸²å£: {config.port}")
    print(f"æ³¢ç‰¹ç‡: {config.baudrate}")
    print(f"è®¾å¤‡åœ°å€: {config.address}")
    print("-" * 50)
    
    try:
        # åˆ›å»ºè®¾å¤‡å®ä¾‹
        device = LaiYuLiquid(config)
        
        # å°è¯•è¿æ¥å’Œåˆå§‹åŒ–
        print("ğŸ“¡ æ­£åœ¨è¿æ¥è®¾å¤‡...")
        success = await device.setup()
        
        if success:
            print("âœ… è®¾å¤‡è¿æ¥æˆåŠŸ!")
            print(f"è¿æ¥çŠ¶æ€: {device.is_connected}")
            print(f"åˆå§‹åŒ–çŠ¶æ€: {device.is_initialized}")
            print(f"å½“å‰ä½ç½®: {device.current_position}")
            
            # è·å–è®¾å¤‡çŠ¶æ€
            status = device.get_status()
            print("\nğŸ“Š è®¾å¤‡çŠ¶æ€:")
            for key, value in status.items():
                print(f"  {key}: {value}")
                
        else:
            print("âŒ è®¾å¤‡è¿æ¥å¤±è´¥!")
            print("è¯·æ£€æŸ¥:")
            print("  1. ä¸²å£å·æ˜¯å¦æ­£ç¡®")
            print("  2. è®¾å¤‡æ˜¯å¦å·²è¿æ¥å¹¶é€šç”µ")
            print("  3. æ³¢ç‰¹ç‡å’Œè®¾å¤‡åœ°å€æ˜¯å¦åŒ¹é…")
            print("  4. ä¸²å£æ˜¯å¦è¢«å…¶ä»–ç¨‹åºå ç”¨")
            
    except Exception as e:
        print(f"âŒ è¿æ¥æµ‹è¯•å‡ºé”™: {e}")
        print("\nğŸ”§ æ•…éšœæ’é™¤å»ºè®®:")
        print("  1. æ£€æŸ¥ä¸²å£è®¾å¤‡æ˜¯å¦å­˜åœ¨:")
        print("     macOS: ls /dev/cu.*")
        print("     Linux: ls /dev/ttyUSB* /dev/ttyACM*")
        print("  2. æ£€æŸ¥è®¾å¤‡æƒé™:")
        print("     sudo chmod 666 /dev/cu.usbserial-*")
        print("  3. æ£€æŸ¥è®¾å¤‡æ˜¯å¦è¢«å ç”¨:")
        print("     lsof | grep /dev/cu.usbserial")
        
    finally:
        # æ¸…ç†è¿æ¥
        if 'device' in locals():
            await device.stop()

if __name__ == "__main__":
    import asyncio
    asyncio.run(test_connection())
```

### 2. å‘½ä»¤è¡ŒéªŒè¯å·¥å…·

#### ä¸²å£é€šä¿¡æµ‹è¯•
```bash
# å®‰è£…ä¸²å£è°ƒè¯•å·¥å…·
pip install pyserial

# ä½¿ç”¨Pythonæµ‹è¯•ä¸²å£
python -c "
import serial
try:
    ser = serial.Serial('/dev/cu.usbserial-3130', 9600, timeout=1)
    print('ä¸²å£è¿æ¥æˆåŠŸ:', ser.is_open)
    ser.close()
except Exception as e:
    print('ä¸²å£è¿æ¥å¤±è´¥:', e)
"
```

#### è®¾å¤‡æƒé™æ£€æŸ¥
```bash
# macOS/Linux æ£€æŸ¥ä¸²å£æƒé™
ls -la /dev/cu.usbserial-*

# å¦‚æœæƒé™ä¸è¶³ï¼Œä¿®æ”¹æƒé™
sudo chmod 666 /dev/cu.usbserial-*

# æ£€æŸ¥ä¸²å£æ˜¯å¦è¢«å ç”¨
lsof | grep /dev/cu.usbserial
```

### 3. è¿æ¥çŠ¶æ€æŒ‡ç¤ºå™¨

è®¾å¤‡æä¾›å¤šç§æ–¹å¼æ£€æŸ¥è¿æ¥çŠ¶æ€ï¼š

#### A. å±æ€§æ£€æŸ¥
```python
device = LaiYuLiquid(config)

# æ£€æŸ¥è¿æ¥çŠ¶æ€
print(f"è®¾å¤‡å·²è¿æ¥: {device.is_connected}")
print(f"è®¾å¤‡å·²åˆå§‹åŒ–: {device.is_initialized}")
print(f"æªå¤´å·²å®‰è£…: {device.tip_attached}")
print(f"å½“å‰ä½ç½®: {device.current_position}")
print(f"å½“å‰ä½“ç§¯: {device.current_volume}")
```

#### B. çŠ¶æ€å­—å…¸
```python
status = device.get_status()
print("å®Œæ•´è®¾å¤‡çŠ¶æ€:", status)

# è¾“å‡ºç¤ºä¾‹:
# {
#     'connected': True,
#     'initialized': True, 
#     'position': (0.0, 0.0, 50.0),
#     'tip_attached': False,
#     'current_volume': 0.0,
#     'last_error': None
# }
```

## ğŸš¨ å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### 1. ä¸²å£è¿æ¥å¤±è´¥

**é—®é¢˜**: `serial.serialutil.SerialException: could not open port`

**è§£å†³æ–¹æ¡ˆ**:
```bash
# 1. æ£€æŸ¥ä¸²å£æ˜¯å¦å­˜åœ¨
ls /dev/cu.*

# 2. æ£€æŸ¥æƒé™
sudo chmod 666 /dev/cu.usbserial-*

# 3. æ£€æŸ¥æ˜¯å¦è¢«å ç”¨
lsof | grep /dev/cu.usbserial

# 4. é‡æ–°æ’æ‹”USBè®¾å¤‡
```

### 2. è®¾å¤‡åœ°å€å†²çª

**é—®é¢˜**: å¤šä¸ªè®¾å¤‡ä½¿ç”¨ç›¸åŒåœ°å€

**è§£å†³æ–¹æ¡ˆ**:
- XYZæ§åˆ¶å™¨: åœ°å€ 1-3 (å¯¹åº”Xã€Yã€Zè½´)
- ç§»æ¶²å™¨: åœ°å€ 4 (é¿å…ä¸æ­¥è¿›ç”µæœºå†²çª)
- ç¦ç”¨åœ°å€: 47 ('/'), 69 ('E'), 91 ('[')

### 3. æ³¢ç‰¹ç‡ä¸åŒ¹é…

**é—®é¢˜**: é€šä¿¡ä¹±ç æˆ–æ— å“åº”

**è§£å†³æ–¹æ¡ˆ**:
```python
# å¸¸è§æ³¢ç‰¹ç‡è®¾ç½®
baudrate_options = [9600, 19200, 38400, 57600, 115200]

# é€ä¸€æµ‹è¯•
for baudrate in baudrate_options:
    try:
        config.baudrate = baudrate
        device = LaiYuLiquid(config)
        if await device.setup():
            print(f"æ­£ç¡®æ³¢ç‰¹ç‡: {baudrate}")
            break
    except:
        continue
```

### 4. è¶…æ—¶é—®é¢˜

**é—®é¢˜**: è®¾å¤‡å“åº”ç¼“æ…¢

**è§£å†³æ–¹æ¡ˆ**:
```python
# å¢åŠ è¶…æ—¶æ—¶é—´
config.timeout = 10.0  # ä»5ç§’å¢åŠ åˆ°10ç§’

# æˆ–åœ¨æ§åˆ¶å™¨çº§åˆ«è®¾ç½®
xyz_controller = XYZController(port, timeout=10.0)
pipette_controller = PipetteController(port, timeout=10.0)
```

## ğŸ“ é…ç½®æ–‡ä»¶æ¨¡æ¿

### å®Œæ•´é…ç½®ç¤ºä¾‹
```json
{
    "laiyu_liquid_config": {
        "communication": {
            "xyz_controller": {
                "port": "/dev/cu.usbserial-3130",
                "baudrate": 115200,
                "timeout": 5.0
            },
            "pipette_controller": {
                "port": "/dev/cu.usbserial-3131", 
                "baudrate": 115200,
                "address": 4,
                "timeout": 5.0
            }
        },
        "mechanical": {
            "deck_width": 340.0,
            "deck_height": 250.0,
            "deck_depth": 160.0,
            "safe_height": 50.0
        },
        "motion": {
            "max_speed": 100.0,
            "acceleration": 50.0,
            "tip_pickup_speed": 30,
            "tip_pickup_acceleration": 500
        },
        "safety": {
            "position_validation": true,
            "emergency_stop_enabled": true,
            "deck_width": 300.0,
            "deck_height": 200.0,
            "deck_depth": 100.0,
            "safe_height": 50.0
        }
    }
}
```

## ğŸ”§ è°ƒè¯•å’Œæ—¥å¿—

### å¯ç”¨è¯¦ç»†æ—¥å¿—
```python
import logging

# è®¾ç½®æ—¥å¿—çº§åˆ«
logging.basicConfig(level=logging.DEBUG)

# æˆ–é’ˆå¯¹ç‰¹å®šæ¨¡å—
logger = logging.getLogger('unilabos.devices.LaiYu_Liquid')
logger.setLevel(logging.DEBUG)
```

### é€šä¿¡è°ƒè¯•
```python
# åœ¨æ§åˆ¶å™¨ä¸­å¯ç”¨è°ƒè¯•æ¨¡å¼
xyz_controller = XYZController(port, debug=True)
pipette_controller = PipetteController(port, debug=True)
```

